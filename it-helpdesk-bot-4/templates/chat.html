{% extends "base.html" %}

{% block title %}Chat - Pingpal{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    height: calc(100vh - 200px);
    max-height: 600px;
}

.chat-messages {
    height: calc(100% - 120px);
    overflow-y: auto;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 25px;
    box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
}

.message {
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start;
    animation: slideIn 0.3s ease-out;
}

.message.user {
    justify-content: flex-end;
}

.message.bot {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 75%;
    padding: 16px 20px;
    border-radius: 20px;
    word-wrap: break-word;
    line-height: 1.6;
    font-size: 1rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    position: relative;
}

.message-bubble:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.message.user .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 6px;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.message.bot .message-bubble {
    background: white;
    color: #2c3e50;
    border: 1px solid #e3e6f0;
    border-bottom-left-radius: 6px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

/* Enhanced typography for bot messages */
.message.bot .message-bubble {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.8;
}

.message.bot .message-bubble strong {
    color: #2c3e50;
    font-weight: 700;
    letter-spacing: 0.02em;
}

.message.bot .message-bubble h1, 
.message.bot .message-bubble h2, 
.message.bot .message-bubble h3, 
.message.bot .message-bubble h4, 
.message.bot .message-bubble h5, 
.message.bot .message-bubble h6 {
    color: #1a202c;
    margin-top: 20px;
    margin-bottom: 12px;
    font-weight: 700;
    letter-spacing: 0.02em;
    line-height: 1.4;
}

.message.bot .message-bubble h4 {
    font-size: 1.3rem;
    color: #667eea;
}

.message.bot .message-bubble h5 {
    font-size: 1.2rem;
    color: #764ba2;
}

.message.bot .message-bubble h6 {
    font-size: 1.1rem;
    color: #2c3e50;
}

.message.bot .message-bubble ul, 
.message.bot .message-bubble ol {
    margin: 16px 0;
    padding-left: 24px;
}

.message.bot .message-bubble li {
    margin: 8px 0;
    line-height: 1.6;
    color: #4a5568;
}

.message.bot .message-bubble li strong {
    color: #2c3e50;
}

.message.bot .message-bubble code {
    background: #f7fafc;
    color: #e53e3e;
    padding: 3px 8px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    border: 1px solid #e2e8f0;
    font-weight: 600;
}

.message.bot .message-bubble pre {
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 16px;
    margin: 16px 0;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.5;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
}

.message.bot .message-bubble blockquote {
    border-left: 4px solid #667eea;
    padding-left: 20px;
    margin: 16px 0;
    color: #4a5568;
    font-style: italic;
    background: #f8f9fa;
    padding: 12px 20px;
    border-radius: 0 8px 8px 0;
}

.message.bot .message-bubble p {
    margin: 12px 0;
    line-height: 1.7;
    color: #4a5568;
}

/* Diagnostic permission dialog */
.diagnostic-permission {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
}

.diagnostic-permission h6 {
    color: #856404;
    margin-bottom: 8px;
    font-weight: 600;
}

.diagnostic-permission p {
    color: #856404;
    margin-bottom: 12px;
    font-size: 0.9rem;
}

.diagnostic-permission-buttons {
    display: flex;
    gap: 8px;
}

.diagnostic-permission-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.diagnostic-permission-btn.approve {
    background: #28a745;
    color: white;
}

.diagnostic-permission-btn.approve:hover {
    background: #218838;
}

.diagnostic-permission-btn.decline {
    background: #6c757d;
    color: white;
}

.diagnostic-permission-btn.decline:hover {
    background: #5a6268;
}

/* Diagnostic results */
.diagnostic-result {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.diagnostic-result.success {
    border-left: 4px solid #28a745;
    background: #f8fff9;
}

.diagnostic-result.error {
    border-left: 4px solid #dc3545;
    background: #fff8f8;
}

.diagnostic-result h6 {
    margin-bottom: 8px;
    font-weight: 600;
}

.diagnostic-result.success h6 {
    color: #155724;
}

.diagnostic-result.error h6 {
    color: #721c24;
}

.diagnostic-output {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    white-space: pre-wrap;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 8px;
}

/* Quick action buttons for diagnostics */
.diagnostic-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 12px 0;
}

.diagnostic-action-btn {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    border: 1px solid #667eea;
    background: white;
    color: #667eea;
    cursor: pointer;
    transition: all 0.2s ease;
}

.diagnostic-action-btn:hover {
    background: #667eea;
    color: white;
}

.diagnostic-action-btn.risk-low {
    border-color: #28a745;
    color: #28a745;
}

.diagnostic-action-btn.risk-low:hover {
    background: #28a745;
    color: white;
}

.diagnostic-action-btn.risk-medium {
    border-color: #ffc107;
    color: #856404;
}

.diagnostic-action-btn.risk-medium:hover {
    background: #ffc107;
    color: #856404;
}

.diagnostic-action-btn.risk-high {
    border-color: #dc3545;
    color: #dc3545;
}

.diagnostic-action-btn.risk-high:hover {
    background: #dc3545;
    color: white;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 8px;
    opacity: 0.8;
}

.message.user .message-time {
    color: rgba(255, 255, 255, 0.8);
}

.typing-indicator {
    display: none;
    padding: 16px 20px;
    background: white;
    border: 1px solid #e3e6f0;
    border-radius: 20px;
    border-bottom-left-radius: 6px;
    max-width: 75%;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.typing-dots {
    display: inline-block;
}

.typing-dots span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #667eea;
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.message {
    animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.quick-actions {
    margin-bottom: 20px;
}

.quick-action-btn {
    margin: 3px;
    font-size: 0.875rem;
    border-radius: 20px;
    padding: 8px 16px;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.command-output {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 16px;
    margin-top: 12px;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
    max-height: 250px;
    overflow-y: auto;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
    line-height: 1.5;
}

.command-success {
    border-left: 4px solid #28a745;
    background: #f8fff9;
}

.command-error {
    border-left: 4px solid #dc3545;
    background: #fff8f8;
}

.command-loading {
    display: flex;
    align-items: center;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 8px;
    color: #6c757d;
    font-style: italic;
}

.command-loading .spinner-border {
    color: #667eea;
}

/* Ensure Bootstrap spinner is visible */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.2em;
}

.spinner-border {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    vertical-align: text-bottom;
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border 0.75s linear infinite;
}

@keyframes spinner-border {
    to {
        transform: rotate(360deg);
    }
}

.chat-input-container {
    position: relative;
    margin-top: 10px;
}

.chat-input {
    border-radius: 25px;
    padding: 14px 60px 14px 20px;
    border: 2px solid #e3e6f0;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.chat-input:focus {
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    outline: none;
}

.send-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.send-btn:hover {
    transform: translateY(-50%) scale(1.05);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.system-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.os-badge {
    font-size: 0.875rem;
    padding: 6px 14px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.2);
    display: inline-block;
    margin-bottom: 12px;
    backdrop-filter: blur(10px);
}

/* Responsive design improvements */
@media (max-width: 768px) {
    .message-bubble {
        max-width: 88%;
        font-size: 0.95rem;
        padding: 14px 18px;
        line-height: 1.6;
    }
    
    .chat-messages {
        padding: 20px;
    }
    
    .quick-action-btn {
        font-size: 0.8rem;
        padding: 6px 12px;
    }
    
    .diagnostic-actions {
        flex-direction: column;
    }
    
    .diagnostic-action-btn {
        width: 100%;
        text-align: center;
    }
}

/* Scrollbar styling */
.chat-messages::-webkit-scrollbar {
    width: 8px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Run command buttons */
.run-command-btn {
    transition: all 0.2s ease;
    border-radius: 6px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.run-command-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.run-command-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.run-command-btn .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Command container styling */
.command-container {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.command-container code {
    flex: 1;
    min-width: 200px;
    margin: 0;
}

/* Responsive design for command buttons */
@media (max-width: 768px) {
    .command-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .command-container code {
        min-width: auto;
        margin-bottom: 8px;
    }
    
    .run-command-btn {
        align-self: flex-start;
    }
}

/* Network warning styling */
.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.alert-warning strong {
    color: #856404;
}

/* Command description styling */
.command-description {
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 4px;
    font-style: italic;
}

/* Category headers */
.message-bubble strong {
    color: #667eea;
    font-size: 1.1em;
    margin-bottom: 8px;
    display: block;
}

/* Ensure command containers work in bot messages */
.message.bot .message-bubble .command-container {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.message.bot .message-bubble .command-container code {
    flex: 1;
    min-width: 200px;
    margin: 0;
    background: #f7fafc;
    color: #e53e3e;
    padding: 6px 10px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    border: 1px solid #e2e8f0;
}

.message.bot .message-bubble .command-description {
    color: #6c757d;
    font-size: 0.9em;
    margin-top: 4px;
    font-style: italic;
    width: 100%;
}

.message.bot .message-bubble .run-command-btn {
    transition: all 0.2s ease;
    border-radius: 6px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.message.bot .message-bubble .run-command-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* Password prompt styling */
.message.bot .message-bubble .password-prompt {
    margin-top: 8px;
    padding: 8px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.message.bot .message-bubble .password-prompt input {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.9em;
}

.message.bot .message-bubble .password-prompt .btn {
    margin: 2px 0;
    font-size: 0.8em;
    padding: 4px 8px;
}

/* Sudo command styling */
.message.bot .message-bubble .run-command-btn.btn-outline-warning {
    border-color: #ffc107;
    color: #856404;
}

.message.bot .message-bubble .run-command-btn.btn-outline-warning:hover {
    background-color: #ffc107;
    color: #856404;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Chat Interface -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='assets/logo.png') }}" alt="Pingpal Logo" class="chat-header-logo me-2">
                        <h5 class="mb-0">
                                Pingpal
                        </h5>
                        </div>
                        <div class="d-flex align-items-center">
                            <div id="connection-status" class="me-3">
                                <span class="badge bg-secondary">
                                    <i class="fas fa-circle me-1"></i>Connecting...
                                </span>
                            </div>
                            <button class="btn btn-outline-light btn-sm" onclick="clearChat()">
                                <i class="fas fa-trash me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <!-- System Info Card -->
                    <div id="system-info-card" class="system-info-card mx-3 mt-3">
                        <div class="os-badge">
                            <i class="fas fa-desktop me-1"></i>
                            <span id="os-type">Detecting OS...</span>
                        </div>
                        <h6 class="mb-2">Welcome to Pingpal!</h6>
                        <p class="mb-0 small">
                            I'm your intelligent IT support assistant. I can help you troubleshoot issues, 
                            run system diagnostics, and provide step-by-step guidance for your system.
                            <br><br>
                            <strong>💡 Tip:</strong> Describe your IT issue in detail, and I'll suggest 
                            automated diagnostics to help solve it quickly!
                        </p>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions mx-3">
                        <button class="btn btn-outline-primary btn-sm quick-action-btn" onclick="runQuickPingTest()">
                            <i class="fas fa-wifi me-1"></i>Ping Test
                        </button>
                        <button class="btn btn-outline-success btn-sm quick-action-btn" onclick="runSystemInfo()">
                            <i class="fas fa-server me-1"></i>System Info
                        </button>
                        <button class="btn btn-outline-info btn-sm quick-action-btn" onclick="runProcessCheck()">
                            <i class="fas fa-list me-1"></i>Processes
                        </button>
                        <button class="btn btn-outline-warning btn-sm quick-action-btn" onclick="runDiskSpaceCheck()">
                            <i class="fas fa-hdd me-1"></i>Disk Space
                        </button>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div class="chat-container">
                        <div id="chat-messages" class="chat-messages">
                            <!-- Messages will be added here -->
                        </div>
                        
                        <!-- Typing Indicator -->
                        <div id="typing-indicator" class="typing-indicator">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <span class="ms-2">Pingpal is typing...</span>
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="p-3 border-top">
                            <div class="chat-input-container">
                                <input type="text" id="message-input" class="form-control chat-input" 
                                       placeholder="Describe your IT issue..." 
                                       onkeypress="handleKeyPress(event)">
                                <button id="send-btn" class="btn btn-primary send-btn" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Quick Tools
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>System Commands</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="runQuickPingTest()">
                                <i class="fas fa-wifi me-1"></i>Ping Test
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="executeCommand('nslookup google.com')">
                                <i class="fas fa-search me-1"></i>DNS Lookup
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="executeCommand('systeminfo')">
                                <i class="fas fa-info-circle me-1"></i>System Info
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Network Tools</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning btn-sm" onclick="runNetworkDiagnostics()">
                                <i class="fas fa-network-wired me-1"></i>Full Network Test
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="executeCommand('ipconfig')">
                                <i class="fas fa-ethernet me-1"></i>Network Config
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="runMacOSNetworkTest()" id="macos-network-btn" style="display: none;">
                                <i class="fab fa-apple me-1"></i>macOS Network Info
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>System Health</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="executeCommand('tasklist')">
                                <i class="fas fa-list me-1"></i>Running Processes
                            </button>
                            <button class="btn btn-outline-dark btn-sm" onclick="executeCommand('dir')">
                                <i class="fas fa-folder me-1"></i>Directory Listing
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Performance</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info btn-sm" onclick="clearCache()">
                                <i class="fas fa-broom me-1"></i>Clear Cache
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="getCacheStats()">
                                <i class="fas fa-chart-bar me-1"></i>Cache Stats
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="testCommand()">
                                <i class="fas fa-vial me-1"></i>Test Command
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="getSessionStats()">
                                <i class="fas fa-database me-1"></i>Session Stats
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let socket;
let isConnected = false;
let pendingDiagnostics = [];
let currentSessionId = null;

// Add global variables to track last user and bot messages
let lastUserMessage = '';
let lastBotResponse = '';

// Initialize WebSocket connection
document.addEventListener('DOMContentLoaded', function() {
    initializeSocket();
    loadSystemInfo();
    createNewSession();
    checkNetworkStatus();
});

function checkNetworkStatus() {
    fetch('/api/network/status')
        .then(response => response.json())
        .then(data => {
            if (!data.internet_available) {
                showNetworkWarning();
            }
        })
        .catch(error => {
            console.error('Error checking network status:', error);
            showNetworkWarning();
        });
}

function showNetworkWarning() {
    const messagesContainer = document.getElementById('chat-messages');
    const warningDiv = document.createElement('div');
    warningDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    warningDiv.innerHTML = `
        <div class="message-bubble">
            <div class="alert alert-warning" role="alert">
                <strong>⚠️ No Internet Connection Detected</strong><br>
                I can still help you troubleshoot network issues with local diagnostic commands.
                <br><br>
                <button class="btn btn-primary btn-sm" onclick="loadNetworkFallbackCommands()">
                    <i class="fas fa-wifi me-1"></i>Load Network Diagnostics
                </button>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(warningDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function loadNetworkFallbackCommands() {
    fetch('/api/network/fallback-commands')
        .then(response => response.json())
        .then(data => {
            const messagesContainer = document.getElementById('chat-messages');
            const commandsDiv = document.createElement('div');
            commandsDiv.className = 'message bot';
            
            const time = new Date();
            const timeString = time.toLocaleTimeString();
            
            let commandsHtml = `
                <div class="message-bubble">
                    <strong>🔧 Network Diagnostic Commands for ${data.os_type}:</strong><br><br>
            `;
            
            // Group commands by category
            const categories = {};
            data.commands.forEach(cmd => {
                if (!categories[cmd.category]) {
                    categories[cmd.category] = [];
                }
                categories[cmd.category].push(cmd);
            });
            
            for (const [category, commands] of Object.entries(categories)) {
                commandsHtml += `<strong>${category.replace('_', ' ').toUpperCase()}:</strong><br>`;
                commands.forEach(cmd => {
                    commandsHtml += `
                        <div class="command-container">
                            <code>${cmd.command}</code>
                            <button class="btn btn-sm btn-outline-primary run-command-btn" onclick="executeCommand('${cmd.command}')">
                                <i class="fas fa-play me-1"></i>Run
                            </button>
                            <div class="command-description">${cmd.description}</div>
                        </div>
                    `;
                });
                commandsHtml += '<br>';
            }
            
            commandsHtml += `
                <strong>📋 Troubleshooting Steps:</strong><br>
                <ul>
            `;
            
            data.troubleshooting_steps.forEach(step => {
                commandsHtml += `<li>${step}</li>`;
            });
            
            commandsHtml += `
                </ul>
                <div class="message-time">${timeString}</div>
            </div>
            `;
            
            commandsDiv.innerHTML = commandsHtml;
            messagesContainer.appendChild(commandsDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        })
        .catch(error => {
            console.error('Error loading fallback commands:', error);
        });
}

function initializeSocket() {
    try {
        socket = io({
            transports: ['websocket', 'polling'],
            timeout: 10000
        });
        
        socket.on('connect', function() {
            isConnected = true;
            updateConnectionStatus('Connected', 'success');
            console.log('WebSocket connected successfully');
            // Don't send any automatic messages - let user initiate conversation
        });
        
        socket.on('disconnect', function() {
            isConnected = false;
            updateConnectionStatus('Disconnected', 'danger');
            console.log('WebSocket disconnected');
        });
        
        socket.on('connect_error', function(error) {
            console.error('WebSocket connection error:', error);
            updateConnectionStatus('Connection Failed', 'danger');
            isConnected = false;
        });
        
        // In initializeSocket, update bot_response handler to support {message: {...}, timestamp: ...} structure
        socket.on('bot_response', function(data) {
            hideTypingIndicator();
            let payload = data;
            if (typeof data === 'string') {
                try { payload = JSON.parse(data); } catch (e) { payload = { response: data }; }
            }
            // If payload has a .message property, use that as the real payload
            if (payload && payload.message) {
                payload = payload.message;
            }
            let responseText = '';
            if (payload && typeof payload.response === 'string') {
                responseText = payload.response;
            } else if (payload && payload.response) {
                responseText = String(payload.response);
            }
            addMessage('bot', responseText, null, payload.system_commands);
        });
        
        socket.on('error', function(data) {
            hideTypingIndicator();
            addMessage('bot', 'Sorry, I encountered an error. Please try again.');
        });
        
        // Set a timeout to fallback to REST API if WebSocket doesn't connect
        setTimeout(function() {
            if (!isConnected) {
                console.log('WebSocket connection timeout, using REST API fallback');
                updateConnectionStatus('Using REST API', 'warning');
            }
        }, 5000);
        
    } catch (error) {
        console.error('Error initializing WebSocket:', error);
        updateConnectionStatus('WebSocket Error', 'danger');
        isConnected = false;
    }
}

function updateConnectionStatus(status, type) {
    const statusElement = document.getElementById('connection-status');
    statusElement.innerHTML = `
        <span class="badge bg-${type}">
            <i class="fas fa-circle me-1"></i>${status}
        </span>
    `;
}

function loadSystemInfo() {
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                const osType = data.os_type;
                document.getElementById('os-type').textContent = osType;
                
                // Show macOS-specific buttons if on macOS
                if (osType.toLowerCase().includes('darwin') || osType.toLowerCase().includes('mac')) {
                    const macosBtn = document.getElementById('macos-network-btn');
                    if (macosBtn) {
                        macosBtn.style.display = 'block';
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error loading system info:', error);
        });
}

function createNewSession() {
    fetch('/api/session/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.session_id) {
            currentSessionId = data.session_id;
            console.log('Created new session:', currentSessionId);
        }
    })
    .catch(error => {
        console.error('Error creating session:', error);
        });
}

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage('user', message);
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send message via WebSocket if connected
    if (isConnected && socket) {
        try {
            socket.emit('send_message', { 
                message: message,
                session_id: currentSessionId 
            });
        } catch (error) {
            console.error('WebSocket send error:', error);
            // Fallback to REST API
            sendMessageViaAPI(message);
        }
    } else {
        // Fallback to REST API
        sendMessageViaAPI(message);
    }
}

function sendMessageViaAPI(message) {
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            message: message,
            session_id: currentSessionId 
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Received response from API:', data);
        hideTypingIndicator();
        let responseText = '';
        if (data && typeof data.response === 'string') {
            responseText = data.response;
        } else if (data && data.response) {
            responseText = String(data.response);
        }
        if (data.error) {
            console.error('API returned error:', data.error);
            addMessage('bot', 'Sorry, I encountered an error. Please try again.');
        } else {
            console.log('Adding bot message with response:', responseText);
            console.log('System commands:', data.system_commands);
            addMessage('bot', responseText, null, data.system_commands);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideTypingIndicator();
        addMessage('bot', 'Sorry, I encountered an error. Please try again.');
    });
}

function sendQuickMessage(message) {
    document.getElementById('message-input').value = message;
    sendMessage();
}

function addMessage(sender, content, timestamp = null, systemCommands = []) {
    // Defensive: always ensure content is a string
    if (typeof content !== 'string') {
        content = content ? String(content) : '';
    }
    if (sender === 'user') {
        lastUserMessage = content;
    } else if (sender === 'bot') {
        lastBotResponse = content;
    }
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const time = timestamp ? new Date(timestamp) : new Date();
    const timeString = time.toLocaleTimeString();
    
    // Format content for bot messages (markdown-like formatting)
    let formattedContent = content;
    if (sender === 'bot') {
        formattedContent = formatBotMessage(content);
    }
    
    // Create the message bubble
    const messageBubble = document.createElement('div');
    messageBubble.className = 'message-bubble';
    messageBubble.innerHTML = formattedContent;
    
    // Add timestamp
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = timeString;
    messageBubble.appendChild(timeDiv);
    
    messageDiv.appendChild(messageBubble);
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Render system commands as cards below the message
    if (sender === 'bot' && systemCommands && systemCommands.length > 0) {
        systemCommands.forEach((cmd, idx) => {
            renderCommandCard(cmd, idx);
        });
    }
}

function formatBotMessage(content) {
    if (!content) return '';
    
    // Check if content already contains HTML (like our fallback response)
    if (content.includes('<div class="command-container">') || content.includes('<button')) {
        // Content already has HTML, just return it with basic styling
        return content;
    }
    
    // Use marked.js for markdown rendering
    if (typeof marked !== 'undefined') {
        marked.setOptions({ breaks: true, gfm: true });
        let formatted = marked.parse(content);
        formatted = formatted.replace(/<strong>(.*?)<\/strong>/g, '<strong style="color: #2c3e50; font-weight: 600;">$1</strong>');
        formatted = formatted.replace(/<code>(.*?)<\/code>/g, '<code style="background: #f7fafc; color: #e53e3e; padding: 2px 6px; border-radius: 4px; font-family: \'Courier New\', monospace; font-size: 0.9em; border: 1px solid #e2e8f0;">$1</code>');
        formatted = formatted.replace(/<h([1-6])>(.*?)<\/h[1-6]>/g, '<h$1 style="color: #1a202c; margin-top: 16px; margin-bottom: 8px; font-weight: 600;">$2</h$1>');
        formatted = formatted.replace(/<ul>(.*?)<\/ul>/g, '<ul style="margin: 12px 0; padding-left: 20px;">$1</ul>');
        formatted = formatted.replace(/<ol>(.*?)<\/ol>/g, '<ol style="margin: 12px 0; padding-left: 20px;">$1</ol>');
        formatted = formatted.replace(/<li>(.*?)<\/li>/g, '<li style="margin: 6px 0; line-height: 1.5;">$1</li>');
        formatted = formatted.replace(/<p>(.*?)<\/p>/g, '<p style="margin: 8px 0; line-height: 1.6;">$1</p>');
        return formatted;
    } else {
        let formatted = content;
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
        formatted = formatted.replace(/^# (.*$)/gm, '<h4>$1</h4>');
        formatted = formatted.replace(/^## (.*$)/gm, '<h5>$1</h5>');
        formatted = formatted.replace(/^### (.*$)/gm, '<h6>$1</h6>');
        formatted = formatted.replace(/^• (.*$)/gm, '<li>$1</li>');
        formatted = formatted.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
        formatted = formatted.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
        formatted = formatted.replace(/\n\n/g, '</p><p>');
        formatted = formatted.replace(/\n/g, '<br>');
        if (!formatted.includes('<h') && !formatted.includes('<ul') && !formatted.includes('<code')) {
            formatted = `<p>${formatted}</p>`;
        }
        formatted = formatted.replace(/<p><\/p>/g, '');
        formatted = formatted.replace(/<p><br><\/p>/g, '');
        return formatted;
    }
}



function createDiagnosticPermissionDialog() {
    return `
        <div class="diagnostic-permission">
            <h6><i class="fas fa-shield-alt me-2"></i>Permission Required</h6>
            <p>I can run automated diagnostics to help troubleshoot your issue. Would you like me to proceed?</p>
            <div class="diagnostic-permission-buttons">
                <button class="diagnostic-permission-btn approve" onclick="approveDiagnostics()">
                    <i class="fas fa-check me-1"></i>Yes, run diagnostics
                </button>
                <button class="diagnostic-permission-btn decline" onclick="declineDiagnostics()">
                    <i class="fas fa-times me-1"></i>No, thanks
                </button>
            </div>
        </div>
    `;
}

function approveDiagnostics() {
    // Get the last bot message that contains diagnostic suggestions
    const messages = document.querySelectorAll('.message.bot .message-bubble');
    const lastBotMessage = messages[messages.length - 1];
    
    if (lastBotMessage && lastBotMessage.textContent.includes('🔍 Suggested Diagnostics:')) {
        // Extract diagnostic information and run them
        runSuggestedDiagnostics();
    }
}

function declineDiagnostics() {
    // Remove the permission dialog
    const permissionDialog = document.querySelector('.diagnostic-permission');
    if (permissionDialog) {
        permissionDialog.remove();
    }
}

function runSuggestedDiagnostics() {
    // Get the last user message to determine what diagnostics to run
    const messages = document.querySelectorAll('.message.user .message-bubble');
    const lastUserMessage = messages[messages.length - 1];
    
    if (lastUserMessage) {
        const userMessage = lastUserMessage.textContent;
        console.log('Getting diagnostics for message:', userMessage);
        
        // Get suggested diagnostics from the server
        fetch('/api/diagnostics/suggest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: userMessage })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received diagnostic suggestions:', data);
            if (data.suggestions && data.suggestions.length > 0) {
                // Run each diagnostic with user permission
                runDiagnosticsSequentially(data.suggestions, 0);
            } else {
                addMessage('bot', 'No diagnostics available for your issue. Please try describing your problem in more detail.');
            }
        })
        .catch(error => {
            console.error('Error getting diagnostic suggestions:', error);
            addMessage('bot', `Sorry, I encountered an error while getting diagnostic suggestions: ${error.message}`);
        });
    } else {
        addMessage('bot', 'I couldn\'t find your original message. Please try describing your issue again.');
    }
}

function runDiagnosticsSequentially(diagnostics, index) {
    if (index >= diagnostics.length) {
        return; // All diagnostics completed
    }
    
    const diagnostic = diagnostics[index];
    
    // Create a message div with the diagnostic permission dialog
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    const permissionMessage = `
        <div class="diagnostic-permission">
            <h6><i class="fas fa-cog me-2"></i>Run Diagnostic: ${diagnostic.name}</h6>
            <p>${diagnostic.description}</p>
            <p><strong>Risk Level:</strong> ${diagnostic.risk_level.toUpperCase()}</p>
            <div class="diagnostic-permission-buttons">
                <button class="diagnostic-permission-btn approve" onclick="executeDiagnostic('${diagnostic.name}', '${diagnostic.command}', ${index + 1}, ${diagnostics.length})">
                    <i class="fas fa-play me-1"></i>Run this diagnostic
                </button>
                <button class="diagnostic-permission-btn decline" onclick="skipDiagnostic(${index + 1}, ${diagnostics.length})">
                    <i class="fas fa-forward me-1"></i>Skip this diagnostic
                </button>
            </div>
        </div>
    `;
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${permissionMessage}
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function executeDiagnostic(commandName, command, nextIndex, totalDiagnostics) {
    console.log('Executing diagnostic:', commandName, 'Command:', command);
    
    // Remove the permission dialog
    const permissionDialog = document.querySelector('.diagnostic-permission');
    if (permissionDialog) {
        permissionDialog.remove();
    }
    
    // Show executing message
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    messageDiv.id = 'executing-message';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <strong>🔧 Running: ${commandName}</strong><br><em>Please wait...</em>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Execute the diagnostic
    fetch('/api/diagnostics/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            command_name: commandName,
            command: command 
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Diagnostic execution result:', data);
        
        // Remove the "executing" message
        const executingMessage = document.getElementById('executing-message');
        if (executingMessage) {
            executingMessage.remove();
        }
        
        // Show results
        const resultClass = data.success ? 'success' : 'error';
        const resultIcon = data.success ? '✅' : '❌';
        const resultTitle = data.success ? 'Diagnostic Completed' : 'Diagnostic Failed';
        const output = data.success ? (data.output || 'Command completed successfully') : (data.error || 'Command failed');
        
        const resultMessage = `
            <div class="diagnostic-result ${resultClass}">
                <h6>${resultIcon} ${resultTitle}: ${commandName}</h6>
                <div class="diagnostic-output">${output}</div>
            </div>
        `;
        
        // Create a message div with the diagnostic result
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';
        
        const time = new Date();
        const timeString = time.toLocaleTimeString();
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${resultMessage}
                <div class="message-time">${timeString}</div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Continue with next diagnostic if there are more
        if (nextIndex < totalDiagnostics) {
            setTimeout(() => {
                // Get the original diagnostics list and continue
                getNextDiagnostic(nextIndex);
            }, 1000);
        } else {
            // All diagnostics completed
            addMessage('bot', `<strong>🎉 All diagnostics completed!</strong><br>Check the results above for any issues that need attention.`);
        }
    })
    .catch(error => {
        console.error('Error executing diagnostic:', error);
        
        // Remove the "executing" message
        const executingMessage = document.getElementById('executing-message');
        if (executingMessage) {
            executingMessage.remove();
        }
        
        // Create error message div
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';
        
        const time = new Date();
        const timeString = time.toLocaleTimeString();
        
        const errorMessage = `<div class="diagnostic-result error"><h6>❌ Error: ${commandName}</h6><div class="diagnostic-output">Failed to execute diagnostic: ${error.message}</div></div>`;
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${errorMessage}
                <div class="message-time">${timeString}</div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Continue with next diagnostic if there are more
        if (nextIndex < totalDiagnostics) {
            setTimeout(() => {
                getNextDiagnostic(nextIndex);
            }, 1000);
        }
    });
}

function skipDiagnostic(index, totalDiagnostics) {
    // Remove the permission dialog
    const permissionDialog = document.querySelector('.diagnostic-permission');
    if (permissionDialog) {
        permissionDialog.remove();
    }
    
    // Continue with next diagnostic if there are more
    if (index < totalDiagnostics) {
        getNextDiagnostic(index);
    } else {
        // All diagnostics completed
        addMessage('bot', `<strong>⏭️ Diagnostics skipped!</strong><br>You can run individual diagnostics from the sidebar anytime.`);
    }
}

function getNextDiagnostic(index) {
    // Get the last user message to determine what diagnostics to run
    const messages = document.querySelectorAll('.message.user .message-bubble');
    const lastUserMessage = messages[messages.length - 1];
    
    if (lastUserMessage) {
        const userMessage = lastUserMessage.textContent;
        
        // Get suggested diagnostics from the server
        fetch('/api/diagnostics/suggest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: userMessage })
        })
        .then(response => response.json())
        .then(data => {
            if (data.suggestions && data.suggestions.length > index) {
                // Run the next diagnostic
                runDiagnosticsSequentially(data.suggestions, index);
            }
        })
        .catch(error => {
            console.error('Error getting diagnostic suggestions:', error);
        });
    }
}

function showTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'block';
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'none';
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        document.getElementById('chat-messages').innerHTML = '';
    }
}

function executeCommand(command, password = null) {
    // Show immediate feedback
    const messageId = 'cmd-' + Date.now();
    
    // Create the initial message with loading state
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div id="${messageId}">
                <strong>🔧 Running Command:</strong> ${command}<br>
                <div class="command-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Executing command...</span>
                </div>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Set a timeout for the request
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
    
    // Prepare request body
    const requestBody = { command: command };
    if (password) {
        requestBody.password = password;
    }
    
    fetch('/api/execute-command', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Command execution result:', data);
        
        // Check if password is required
        if (data.requires_password) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                const passwordPrompt = `
                    <strong>🔐 Password Required:</strong> ${command}<br>
                    <div class="command-output command-error">
                        This command requires administrator privileges on macOS.<br>
                        <div class="mt-2">
                            <input type="password" id="sudo-password-${messageId}" class="form-control form-control-sm" placeholder="Enter your password">
                            <button class="btn btn-primary btn-sm mt-2" onclick="executeCommandWithPassword('${command}', '${messageId}')">
                                <i class="fas fa-key me-1"></i>Run with Password
                            </button>
                        </div>
                    </div>
                `;
                messageElement.innerHTML = passwordPrompt;
            }
            return;
        }
        
        const output = data.success ? data.output : data.error;
        const cssClass = data.success ? 'command-success' : 'command-error';
        const icon = data.success ? '✅' : '❌';
        
        // Update the existing message
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            console.log('Updating message element with ID:', messageId);
            // Create the content properly
            const content = `
                <strong>${icon} Command Completed:</strong> ${command}<br>
            <div class="command-output ${cssClass}">${output}</div>
            `;
            messageElement.innerHTML = content;
            
            // Scroll to show the updated message
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else {
            console.error('Message element not found with ID:', messageId);
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('Command execution error:', error);
        
        // Update the existing message with error
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            console.log('Updating message element with error for ID:', messageId);
            const errorContent = `
                <strong>❌ Command Failed:</strong> ${command}<br>
                <div class="command-output command-error">
                    ${error.name === 'AbortError' ? 'Command timed out after 15 seconds' : 'Error executing command. Please try again.'}
                </div>
            `;
            messageElement.innerHTML = errorContent;
            
            // Scroll to show the updated message
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } else {
            console.error('Message element not found for error with ID:', messageId);
        }
    });
}

function executeCommandWithPassword(command, messageId) {
    const passwordInput = document.getElementById(`sudo-password-${messageId}`);
    const password = passwordInput.value;
    
    if (!password) {
        alert('Please enter your password');
        return;
    }
    
    // Clear the password input for security
    passwordInput.value = '';
    
    // Execute the command with password
    executeCommand(command, password);
}

function executeSuggestedCommand(command, description, password = null) {
    // Show loading state first
    const messageId = 'command-execution-' + Date.now();
    
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div id="${messageId}">
                <strong>🛠️ Executing Command...</strong><br>
                <div class="command-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Running: ${description || command}</span>
                </div>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Prepare request body
    const requestBody = { 
        command: command,
        description: description,
        session_id: currentSessionId 
    };
    if (password) {
        requestBody.password = password;
    }
    
    fetch('/api/command/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            // Check if password is required
            if (data.requires_password) {
                const passwordPrompt = `
                    <strong>🔐 Password Required:</strong> ${command}<br>
                    <div class="command-output command-error">
                        This command requires administrator privileges on macOS.<br>
                        <div class="mt-2">
                            <input type="password" id="sudo-password-suggested-${messageId}" class="form-control form-control-sm" placeholder="Enter your password">
                            <button class="btn btn-primary btn-sm mt-2" onclick="executeSuggestedCommandWithPassword('${command}', '${description}', '${messageId}')">
                                <i class="fas fa-key me-1"></i>Run with Password
                            </button>
                        </div>
                    </div>
                `;
                messageElement.innerHTML = passwordPrompt;
                return;
            }
            
            if (data.error) {
                messageElement.innerHTML = `
                    <strong>❌ Command Execution Failed</strong><br>
                    <div class="command-output command-error">
                        <strong>Command:</strong> ${command}<br>
                        <strong>Error:</strong> ${data.error}
                    </div>
                `;
            } else {
                let output = `<strong>✅ Command Executed Successfully</strong><br>`;
                output += `<div class="command-output command-success">`;
                output += `<strong>Command:</strong> ${command}<br>`;
                if (description) {
                    output += `<strong>Description:</strong> ${description}<br>`;
                }
                output += `<strong>Output:</strong><br>`;
                output += `<pre>${data.output}</pre>`;
                if (data.error) {
                    output += `<strong>Error:</strong> ${data.error}`;
                }
                output += `</div>`;
                
                messageElement.innerHTML = output;
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            messageElement.innerHTML = `
                <strong>❌ Command Execution Failed</strong><br>
                <div class="command-output command-error">Error executing command. Please try again.</div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    });
}

function executeSuggestedCommandWithPassword(command, description, messageId) {
    const passwordInput = document.getElementById(`sudo-password-suggested-${messageId}`);
    const password = passwordInput.value;
    
    if (!password) {
        alert('Please enter your password');
        return;
    }
    
    // Clear the password input for security
    passwordInput.value = '';
    
    // Execute the command with password
    executeSuggestedCommand(command, description, password);
}

function showPasswordPrompt(button) {
    const commandContainer = button.closest('.command-container');
    const passwordPrompt = commandContainer.querySelector('.password-prompt');
    const runButton = commandContainer.querySelector('.run-command-btn');
    
    if (passwordPrompt) {
        passwordPrompt.style.display = 'block';
        runButton.style.display = 'none';
    }
}

function cancelPasswordPrompt(button) {
    const commandContainer = button.closest('.command-container');
    const passwordPrompt = commandContainer.querySelector('.password-prompt');
    const runButton = commandContainer.querySelector('.run-command-btn');
    
    if (passwordPrompt) {
        passwordPrompt.style.display = 'none';
        runButton.style.display = 'inline-block';
        // Clear the password input
        const passwordInput = passwordPrompt.querySelector('input[type="password"]');
        if (passwordInput) {
            passwordInput.value = '';
        }
    }
}

function executeCommandWithPasswordFromFallback(command, button) {
    const commandContainer = button.closest('.command-container');
    const passwordInput = commandContainer.querySelector('input[type="password"]');
    const password = passwordInput.value;
    
    if (!password) {
        alert('Please enter your password');
        return;
    }
    
    // Clear the password input for security
    passwordInput.value = '';
    
    // Hide the password prompt
    const passwordPrompt = commandContainer.querySelector('.password-prompt');
    const runButton = commandContainer.querySelector('.run-command-btn');
    if (passwordPrompt) {
        passwordPrompt.style.display = 'none';
        runButton.style.display = 'inline-block';
    }
    
    // Execute the command with password
    executeCommand(command, password);
}

function runNetworkTest() {
    // Use OS-specific ping command with immediate feedback
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('ping google.com -n 4');
    } else if (osType.includes('darwin') || osType.includes('mac')) {
        executeCommand('ping -c 4 google.com');
    } else {
        executeCommand('ping -c 4 google.com');
    }
}

function runSystemInfo() {
    // Use OS-specific system info command with immediate feedback
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('systeminfo');
    } else if (osType.includes('darwin') || osType.includes('mac')) {
        executeCommand('system_profiler SPHardwareDataType');
    } else {
        executeCommand('uname -a && cat /etc/os-release');
    }
}

function runProcessCheck() {
    // Use OS-specific process list command with immediate feedback
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('tasklist');
    } else if (osType.includes('darwin') || osType.includes('mac')) {
        executeCommand('ps aux --sort=-%cpu | head -20');
    } else {
        executeCommand('ps aux --sort=-%cpu | head -20');
    }
}

function runDiskSpaceCheck() {
    // Use OS-specific disk space command with immediate feedback
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('wmic logicaldisk get size,freespace,caption');
    } else if (osType.includes('darwin') || osType.includes('mac')) {
        executeCommand('df -h');
    } else {
        executeCommand('df -h');
    }
}

function runNetworkDiagnostics() {
    // Show loading state first
    const messageId = 'network-test-' + Date.now();
    
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div id="${messageId}">
                <strong>🌐 Running Full Network Test...</strong><br>
                <div class="command-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Testing connectivity and DNS resolution...</span>
                </div>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    fetch('/api/network-test')
        .then(response => response.json())
        .then(data => {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
            if (data.error) {
                    messageElement.innerHTML = `
                        <strong>❌ Network Diagnostics Failed</strong><br>
                        <div class="command-output command-error">${data.error}</div>
                    `;
            } else {
                    let output = '<strong>🌐 Network Diagnostics Results:</strong><br>';
                
                if (data.connectivity) {
                    output += '<br><strong>Internet Connectivity:</strong><br>';
                    Object.entries(data.connectivity).forEach(([host, result]) => {
                            const status = result.success ? '✅' : '❌';
                        output += `${status} ${host}<br>`;
                    });
                }
                
                if (data.dns) {
                    output += '<br><strong>DNS Resolution:</strong><br>';
                    Object.entries(data.dns).forEach(([domain, result]) => {
                            const status = result.success ? '✅' : '❌';
                        output += `${status} ${domain}<br>`;
                    });
                }
                
                    messageElement.innerHTML = `
                        <strong>✅ Network Test Completed</strong><br>
                        <div class="command-output command-success">${output}</div>
                    `;
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.innerHTML = `
                    <strong>❌ Network Test Failed</strong><br>
                    <div class="command-output command-error">Error running network diagnostics. Please try again.</div>
                `;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });
}

function clearCache() {
    // Show loading state first
    const messageId = 'clear-cache-' + Date.now();
    
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div id="${messageId}">
                <strong>🧹 Clearing Cache...</strong><br>
                <div class="command-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Clearing command cache...</span>
                </div>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    fetch('/api/cache/clear', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            if (data.success) {
                messageElement.innerHTML = `
                    <strong>✅ Cache Cleared Successfully</strong><br>
                    <div class="command-output command-success">Command cache has been cleared. Quick tools will now run fresh commands.</div>
                `;
            } else {
                messageElement.innerHTML = `
                    <strong>❌ Cache Clear Failed</strong><br>
                    <div class="command-output command-error">Error: ${data.error}</div>
                `;
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            messageElement.innerHTML = `
                <strong>❌ Cache Clear Failed</strong><br>
                <div class="command-output command-error">Error clearing cache. Please try again.</div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    });
}

function getCacheStats() {
    // Show loading state first
    const messageId = 'cache-stats-' + Date.now();
    
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div id="${messageId}">
                <strong>📊 Getting Cache Statistics...</strong><br>
                <div class="command-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Retrieving cache information...</span>
                </div>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    fetch('/api/cache/stats')
        .then(response => response.json())
        .then(data => {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                if (data.error) {
                    messageElement.innerHTML = `
                        <strong>❌ Cache Stats Error</strong><br>
                        <div class="command-output command-error">Error: ${data.error}</div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <strong>📊 Cache Statistics:</strong><br>
                        <div class="command-output command-success">
                            Total Entries: ${data.total_entries}<br>
                            Valid Entries: ${data.valid_entries}<br>
                            Expired Entries: ${data.expired_entries}<br>
                            Cache Timeout: ${data.cache_timeout} seconds
                        </div>
                    `;
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.innerHTML = `
                    <strong>❌ Cache Stats Error</strong><br>
                    <div class="command-output command-error">Error getting cache statistics. Please try again.</div>
                `;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });
}

function getSessionStats() {
    // Show loading state first
    const messageId = 'session-stats-' + Date.now();
    
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div id="${messageId}">
                <strong>💾 Getting Session Statistics...</strong><br>
                <div class="command-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Retrieving session information...</span>
                </div>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    fetch('/api/session/stats')
        .then(response => response.json())
        .then(data => {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                if (data.error) {
                    messageElement.innerHTML = `
                        <strong>❌ Session Stats Error</strong><br>
                        <div class="command-output command-error">Error: ${data.error}</div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <strong>💾 Session Statistics:</strong><br>
                        <div class="command-output command-success">
                            Total Messages: ${data.total_messages}<br>
                            Total Sessions: ${data.total_sessions}<br>
                            Active Sessions (24h): ${data.active_sessions}<br>
                            Current Session ID: ${currentSessionId || 'Not set'}
                        </div>
                    `;
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.innerHTML = `
                    <strong>❌ Session Stats Error</strong><br>
                    <div class="command-output command-error">Error getting session statistics. Please try again.</div>
                `;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });
}

// Test function to verify command execution
function testCommand() {
    console.log('Testing command execution...');
    executeCommand('echo "Hello World"');
}

function runMacOSNetworkTest() {
    // Show loading state first
    const messageId = 'macos-network-' + Date.now();
    
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    
    const time = new Date();
    const timeString = time.toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div id="${messageId}">
                <strong>🍎 macOS Network Information...</strong><br>
                <div class="command-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Getting macOS-specific network details...</span>
                </div>
            </div>
            <div class="message-time">${timeString}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    fetch('/api/network-test/macos')
        .then(response => response.json())
        .then(data => {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                if (data.error) {
                    messageElement.innerHTML = `
                        <strong>❌ macOS Network Test Failed</strong><br>
                        <div class="command-output command-error">${data.error}</div>
                    `;
                } else {
                    let output = '<strong>🍎 macOS Network Information:</strong><br>';
                    
                    if (data.wifi_info) {
                        output += '<br><strong>WiFi Information:</strong><br>';
                        output += `<div class="command-output command-success">${data.wifi_info}</div>`;
                    }
                    
                    if (data.network_services) {
                        output += '<br><strong>Network Services:</strong><br>';
                        output += `<div class="command-output command-success">${data.network_services}</div>`;
                    }
                    
                    messageElement.innerHTML = `
                        <strong>✅ macOS Network Info Retrieved</strong><br>
                        ${output}
                    `;
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.innerHTML = `
                    <strong>❌ macOS Network Test Failed</strong><br>
                    <div class="command-output command-error">Error getting macOS network information. Please try again.</div>
                `;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });
}

function renderCommandCard(cmd, idx) {
    const messagesContainer = document.getElementById('chat-messages');
    const cardDiv = document.createElement('div');
    cardDiv.className = 'command-container';
    cardDiv.style.marginBottom = '12px';
    cardDiv.style.background = '#f8f9fa';
    cardDiv.style.border = '1px solid #e9ecef';
    cardDiv.style.borderRadius = '8px';
    cardDiv.style.padding = '12px';
    cardDiv.style.display = 'flex';
    cardDiv.style.flexDirection = 'column';
    cardDiv.style.gap = '8px';

    // Command code block
    const codeBlock = document.createElement('code');
    codeBlock.textContent = cmd.command;
    codeBlock.style.background = '#f7fafc';
    codeBlock.style.color = '#e53e3e';
    codeBlock.style.padding = '6px 10px';
    codeBlock.style.borderRadius = '6px';
    codeBlock.style.fontFamily = 'Courier New, monospace';
    codeBlock.style.fontSize = '1em';
    codeBlock.style.border = '1px solid #e2e8f0';
    codeBlock.style.marginBottom = '4px';
    cardDiv.appendChild(codeBlock);

    // Description
    if (cmd.description) {
        const desc = document.createElement('div');
        desc.textContent = cmd.description;
        desc.style.color = '#4a5568';
        desc.style.fontSize = '0.95em';
        desc.style.marginBottom = '4px';
        cardDiv.appendChild(desc);
    }

    // Run button
    const buttonId = `run-command-btn-${Date.now()}-${idx}`;
    const runBtn = document.createElement('button');
    runBtn.id = buttonId;
    runBtn.className = 'btn btn-sm btn-outline-primary run-command-btn';
    runBtn.innerHTML = '<i class="fas fa-play me-1"></i>Run';
    runBtn.onclick = function() {
        runCommandFromCard(cmd.command, buttonId, cardDiv);
    };
    cardDiv.appendChild(runBtn);

    // Result area
    const resultDiv = document.createElement('div');
    resultDiv.className = 'command-result-area';
    resultDiv.style.marginTop = '8px';
    cardDiv.appendChild(resultDiv);

    messagesContainer.appendChild(cardDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function runCommandFromCard(command, buttonId, cardDiv) {
    const runBtn = document.getElementById(buttonId);
    const resultDiv = cardDiv.querySelector('.command-result-area');
    if (runBtn) {
        runBtn.disabled = true;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
        runBtn.className = 'btn btn-sm btn-outline-warning run-command-btn';
    }
    if (resultDiv) {
        resultDiv.innerHTML = '<div class="command-loading"><div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div>Executing command...</div>';
    }
    fetch('/api/command/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            command: command,
            description: `Command from chat: ${command}`,
            session_id: currentSessionId 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (runBtn) {
            runBtn.disabled = false;
            runBtn.innerHTML = '<i class="fas fa-play me-1"></i>Run';
            runBtn.className = 'btn btn-sm btn-outline-primary run-command-btn';
        }
        if (resultDiv) {
            if (data.error) {
                resultDiv.innerHTML = `<div class="command-output command-error"><strong>Error:</strong> ${data.error}</div>`;
            } else {
                let output = `<div class="command-output command-success"><strong>Output:</strong><br><pre>${data.output}</pre></div>`;
                resultDiv.innerHTML = output;
            }
        }
        // Immediately ask the bot to analyze the command result
        analyzeCommandResult(command, data.output, data.error, data.success);
    })
    .catch(error => {
        if (runBtn) {
            runBtn.disabled = false;
            runBtn.innerHTML = '<i class="fas fa-play me-1"></i>Run';
            runBtn.className = 'btn btn-sm btn-outline-primary run-command-btn';
        }
        if (resultDiv) {
            resultDiv.innerHTML = `<div class="command-output command-error">Error executing command. Please try again.</div>`;
        }
    });
}

// New function to analyze command result with the bot
function analyzeCommandResult(command, output, error, success) {
    // Show a spinner bot message
    addMessage('bot', 'Analyzing command result, please wait...');
    fetch('/api/command/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            session_id: currentSessionId,
            command: command,
            output: output,
            error: error,
            success: success,
            user_message: lastUserMessage,
            previous_bot_response: lastBotResponse
        })
    })
    .then(r => r.json())
    .then(data => {
        // Remove the spinner message (last bot message)
        const messagesContainer = document.getElementById('chat-messages');
        const botMessages = messagesContainer.querySelectorAll('.message.bot');
        if (botMessages.length > 0) {
            const lastBot = botMessages[botMessages.length - 1];
            if (lastBot && lastBot.textContent.includes('Analyzing command result')) {
                lastBot.remove();
            }
        }
        addMessage('bot', data.response);
    })
    .catch(error => {
        addMessage('bot', 'Sorry, I could not analyze the command result.');
    });
}

function runQuickPingTest() {
    const osType = document.getElementById('os-type').textContent.toLowerCase();
    if (osType.includes('windows')) {
        executeCommand('ping google.com -n 5');
    } else {
        executeCommand('ping -c 5 google.com');
    }
}
</script>
{% endblock %} 